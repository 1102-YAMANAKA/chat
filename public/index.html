<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>K-Chat</title>
<style>
  body { font-family: sans-serif; background: #fafafa; margin: 20px; }
  h2 { color: #333; margin-bottom: 10px; }
  #messages { list-style: none; padding: 0; height: 70vh; overflow-y: scroll; border: 1px solid #ddd; margin-bottom: 10px; background: white; }
  li { padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
  form { display: flex; gap: 5px; }
  input, button { padding: 10px; font-size: 14px; }
  #name { width: 150px; }
  #input { flex: 1; }
  #chat-container { display: none; }
  #locked { text-align: center; margin-top: 150px; color: #444; font-size: 18px; }
  .delete-btn { background-color: #ff4d4d; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; }
  .delete-btn:hover { background-color: #d22; }
  .name-label { display: inline-block; padding: 2px 6px; border-radius: 4px; margin-right: 4px; }
</style>
</head>
<body>
  <h2>K-Chat</h2>

  <div id="locked">
    ğŸ”’ ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¯ã€Œã‚ã„ã“ã¨ã°ã€ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚
    <br /><br />
    <input id="passInput" type="password" placeholder="ã‚ã„ã“ã¨ã°ã‚’å…¥åŠ›..." />
    <button id="enterBtn" onclick="checkPassword()">å…¥å®¤</button>
    <p id="error" style="color: red"></p>
  </div>

  <div id="chat-container">
    <ul id="messages"></ul>
    <form id="form">
      <input id="name" placeholder="åå‰ã‚’å…¥åŠ›..." autocomplete="off" />
      <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
      <button>é€ä¿¡</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const USER_PASSWORD = "200";
    const ADMIN_PASSWORD = "890";

    const SPECIAL_KEYS = {
      "4545": { name: "æ± åŸ", color: "#ffe4e1" },
      "0823": { name: "å°å³¶", color: "#e6e6fa" },
      "1021": { name: "æ£®ãƒ¦ãƒ¼ãƒˆ", color: "#ccffcc" },
      "1102": { name: "å±±ä¸­", color: "#ccffff" },
      "5555": { name: "å‚å£", color: "#ffffcc" }
    };

    let enteredKey = null;
    let fixedName = null;
    let nameColor = null;
    let isAdmin = false;
    let isSuperAdmin = false;

    const socket = io();
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const nameInput = document.getElementById("name");
    const messages = document.getElementById("messages");

    // ===== Enterã§å…¥å®¤ =====
    document.getElementById("passInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        checkPassword();
      }
    });

    // ===== ã‚ã„ã“ã¨ã°ãƒã‚§ãƒƒã‚¯ =====
    function checkPassword() {
      const val = document.getElementById("passInput").value.trim();
      const error = document.getElementById("error");
      enteredKey = val;

      if (val === USER_PASSWORD) {
        isAdmin = false;
        nameColor = null;
        fixedName = null;
        unlockChat();
      } else if (val === ADMIN_PASSWORD) {
        isAdmin = true;
        isSuperAdmin = true;
        nameColor = "red"; // ç®¡ç†è€…èµ¤æ–‡å­—
        fixedName = null;
        unlockChat();
      } else if (SPECIAL_KEYS[val]) {
        const info = SPECIAL_KEYS[val];
        fixedName = info.name;
        nameColor = info.color;
        if (fixedName === "å±±ä¸­" || fixedName === "å‚å£") isAdmin = true;
        unlockChat();
      } else {
        error.textContent = "âš ï¸ ã‚ã„ã“ã¨ã°ãŒé•ã„ã¾ã™ã€‚";
      }
    }

    // ===== ãƒãƒ£ãƒƒãƒˆè§£æ”¾ =====
    function unlockChat() {
      document.getElementById("locked").style.display = "none";
      document.getElementById("chat-container").style.display = "block";
      socket.emit("join", { admin: isAdmin });
      setTimeout(() => socket.emit("request history"), 200);

      if (fixedName) {
        nameInput.value = fixedName;
        nameInput.disabled = true;
      } else {
        nameInput.disabled = false;
      }
    }

    // ===== JSTæ™‚é–“ =====
    function getJSTDateTime() {
      const now = new Date();
      now.setHours(now.getHours() + 9);
      return now.toISOString().replace("T", " ").substring(0, 19);
    }

    // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ =====
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = fixedName || nameInput.value.trim();
      const text = input.value.trim();
      if (!name || !text) return;

      let appliedColor = nameColor;
      if (enteredKey === USER_PASSWORD) appliedColor = null; // 200ã¯ç„¡è‰²å›ºå®š
      if (enteredKey === ADMIN_PASSWORD) appliedColor = "red"; // 890ã¯èµ¤æ–‡å­—

      const msg = {
        name,
        text,
        timestamp: getJSTDateTime(),
        color: appliedColor,
        senderKey: enteredKey
      };

      socket.emit("chat message", msg);
      input.value = "";
    });

    socket.on("chat history", (list) => {
      messages.innerHTML = "";
      list.forEach((m) => appendMessage(m));
    });

    socket.on("chat message", (m) => appendMessage(m));
    socket.on("remove message", (id) => {
      const li = document.getElementById(id);
      if (li) li.remove();
    });

    // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”» =====
    function appendMessage(m) {
      const li = document.createElement("li");
      li.id = m._id || Math.random().toString(36).substr(2, 9);

      const key = m.senderKey;
      let nameStyle = "";

      // ğŸ”´ 890 â†’ èµ¤æ–‡å­—
      if (key === ADMIN_PASSWORD) {
        nameStyle = "color: red; font-weight: bold;";
      }
      // âš« 200 â†’ ç„¡è‰²ã€è£œå®Œã‚‚ã—ãªã„
      else if (key === USER_PASSWORD) {
        nameStyle = "color: black;";
      }
      // ğŸ¨ ãã®ä»– â†’ è‰²è£œå®Œã‚ã‚Š
      else {
        if (!m.color && m.name) {
          const found = Object.values(SPECIAL_KEYS).find(v => v.name === m.name);
          if (found) m.color = found.color;
        }
        nameStyle = `background-color: ${m.color || "transparent"}; color: black;`;
      }

      const content = `[${m.timestamp}] <span class="name-label" style="${nameStyle}">${m.name}</span>: ${m.text}`;
      li.innerHTML = `<span>${content}</span>`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>
