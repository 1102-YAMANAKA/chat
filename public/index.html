<!DOCTYPE html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6PGFEJBXQ9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6PGFEJBXQ9');
</script>
<meta charset="utf-8" />
<title>K-Chat</title>
<style>
  body { font-family: sans-serif; background: #fafafa; margin: 20px; }
  h2 { color: #333; margin-bottom: 10px; }
  #messages { list-style: none; padding: 0; height: 70vh; overflow-y: scroll; border: 1px solid #ddd; margin-bottom: 10px; background: white; }
  li { padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
  form { display: flex; gap: 5px; }
  input, button { padding: 10px; font-size: 14px; }
  #name { width: 150px; }
  #input { flex: 1; }
  #chat-container { display: none; }
  #locked { text-align: center; margin-top: 150px; color: #444; font-size: 18px; }
  .delete-btn { background-color: #ff4d4d; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; }
  .delete-btn:hover { background-color: #d22; }
  .name-label { display: inline-block; padding: 2px 6px; border-radius: 4px; margin-right: 4px; }
</style>
</head>
<body>
  <h2>K-Chat</h2>



  <div id="locked">
 Â Â  ğŸ”’ ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¯ã€Œã‚ã„ã“ã¨ã°ã€ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚
 Â Â  <br /><br />
 Â Â  <input id="passInput" type="password" placeholder="ã‚ã„ã“ã¨ã°ã‚’å…¥åŠ›..." />
 Â Â  <button id="enterBtn" onclick="checkPassword()">å…¥å®¤</button>
 Â Â  <p id="error" style="color: red"></p>
  </div>



  <div id="chat-container">
 Â Â  <ul id="messages"></ul>
 Â Â  <form id="form">
 Â Â Â Â  <input id="name" placeholder="åå‰ã‚’å…¥åŠ›..." autocomplete="off" />
 Â Â Â Â  <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
 Â Â Â Â  <button>é€ä¿¡</button>
 Â Â  </form>
  </div>



  <script src="/socket.io/socket.io.js"></script>
<script>
  const USER_PASSWORD = "200";
  const ADMIN_PASSWORD = "890";



  const SPECIAL_KEYS = {
 Â Â  "4545": { name: "æ± åŸ", color: "#ffe4e1" },
 Â Â  "0823": { name: "å°å³¶", color: "#e6e6fa" },
 Â Â  "1021": { name: "æ£®ãƒ¦ãƒ¼ãƒˆ", color: "#ccffcc" },
 Â Â  "1102": { name: "å±±ä¸­", color: "#ccffff" },
 Â Â  "5555": { name: "å‚å£", color: "#ffffcc" },
 Â Â  "890": { name: "ç®¡ç†äºº",color: "#ffcccc" }
  };



  // ğŸ”¸ ç®¡ç†äººã‚‚ç¦æ­¢åã«è¿½åŠ 
  const RESERVED_NAMES = ["å‚å£", "å°å³¶", "å±±ä¸­", "æ± åŸ", "æ£®ãƒ¦ãƒ¼ãƒˆ", "ç®¡ç†äºº"];



  let isAdmin = false;
  let isSuperAdmin = false;
  let fixedName = null;
  let nameColor = null;
  let enteredKey = null;



  const socket = io();
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const nameInput = document.getElementById("name");
  const messages = document.getElementById("messages");



  // Enterã§å…¥å®¤
  document.getElementById("passInput").addEventListener("keydown", (e) => {
 Â Â  if (e.key === "Enter") {
 Â Â Â Â  e.preventDefault();
 Â Â Â Â  checkPassword();
 Â Â  }
  });



  function checkPassword() {
 Â Â  const inputVal = document.getElementById("passInput").value.trim();
 Â Â  enteredKey = inputVal;
 Â Â  const error = document.getElementById("error");



 Â Â  if (inputVal === USER_PASSWORD) {
 Â Â Â Â  isAdmin = false;
 Â Â Â Â  unlockChat();
 Â Â  }Â 
 Â Â  else if (inputVal === ADMIN_PASSWORD) {
 Â Â Â Â  isAdmin = true;
 Â Â Â Â  isSuperAdmin = true;
 Â Â Â Â  fixedName = "ç®¡ç†äºº";
 Â Â Â Â  nameColor = null;
 Â Â Â Â  unlockChat();
 Â Â  }Â 
 Â Â  else if (SPECIAL_KEYS[inputVal]) {
 Â Â Â Â  const info = SPECIAL_KEYS[inputVal];
 Â Â Â Â  fixedName = info.name;
 Â Â Â Â  nameColor = info.color;
 Â Â Â Â  if (fixedName === "å±±ä¸­" || fixedName === "å‚å£") {
 Â Â Â Â Â Â  isAdmin = true;
 Â Â Â Â  }
 Â Â Â Â  unlockChat();
 Â Â  }Â 
 Â Â  else {
 Â Â Â Â  error.textContent = "âš ï¸ ã‚ã„ã“ã¨ã°ãŒé•ã„ã¾ã™ã€‚";
 Â Â  }
  }



  function unlockChat() {
 Â Â  document.getElementById("locked").style.display = "none";
 Â Â  document.getElementById("chat-container").style.display = "block";
 Â Â  socket.emit("join", { admin: isAdmin });
 Â Â  setTimeout(() => socket.emit("request history"), 200);



 Â Â  if (fixedName) {
 Â Â Â Â  nameInput.value = fixedName;
 Â Â Â Â  nameInput.disabled = true;
 Â Â  }
  }



  function getJSTDateTime() {
 Â Â  const now = new Date();
 Â Â  now.setHours(now.getHours() + 9);
 Â Â  return now.toISOString().replace("T", " ").substring(0, 19);
  }



  // âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  form.addEventListener("submit", (e) => {
 Â Â  e.preventDefault();



 Â Â  const name = fixedName || nameInput.value.trim();
 Â Â  const text = input.value.trim();



 Â Â  if (!name) {
 Â Â Â Â  alert("âš ï¸ åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
 Â Â Â Â  return;
 Â Â  }



 Â Â  // âœ… 200å…¥å®¤æ™‚ï¼šç¦æ­¢åãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†äººå«ã‚€ï¼‰
 Â Â  if (enteredKey === USER_PASSWORD) {
 Â Â Â Â  const lowerName = name.replace(/\s+/g, "");
 Â Â Â Â  if (RESERVED_NAMES.includes(lowerName)) {
 Â Â Â Â Â Â  alert("âš ï¸ ã“ã®åå‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“");
 Â Â Â Â Â Â  nameInput.value = "";
 Â Â Â Â Â Â  return;
 Â Â Â Â  }
 Â Â  }



 Â Â  if (!text) return;



 Â Â  // âœ… è‰²è¨­å®š
 Â Â  let appliedColor = nameColor;
 Â Â  if (enteredKey === USER_PASSWORD) appliedColor = null;



 Â Â  const msgObj = {
 Â Â Â Â  name,
 Â Â Â Â  text,
 Â Â Â Â  timestamp: getJSTDateTime(),
 Â Â Â Â  color: appliedColor
 Â Â  };
 Â Â  socket.emit("chat message", msgObj);
 Â Â  input.value = "";
  });



  // å±¥æ­´
  socket.on("chat history", (messagesList) => {
 Â Â  messages.innerHTML = "";
 Â Â  messagesList.forEach((m) => appendMessage(m));
  });



  // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  socket.on("chat message", (m) => appendMessage(m));



  // å‰Šé™¤åæ˜ 
  socket.on("remove message", (id) => {
 Â Â  const li = document.getElementById(id);
 Â Â  if (li) li.remove();
  });



  function appendMessage(m) {
 Â Â  const li = document.createElement("li");
 Â Â  li.id = m._id || Math.random().toString(36).substr(2, 9);



 Â Â  if (!m.color && m.name) {
 Â Â Â Â  const found = Object.values(SPECIAL_KEYS).find(v => v.name === m.name);
 Â Â Â Â  if (found) m.color = found.color;
 Â Â  }



 Â Â  const nameStyle = `
 Â Â Â Â  background-color: ${m.color || "transparent"};
 Â Â Â Â  color: black;
 Â Â  `;



 Â Â  const content = `[${m.timestamp}] <span class="name-label" style="${nameStyle}">${m.name}</span>: ${m.text}`;



 Â Â  let deleteButton = "";
 Â Â  if (isAdmin) {
 Â Â Â Â  if (isSuperAdmin) {
 Â Â Â Â Â Â  deleteButton = `<button class="delete-btn" onclick="deleteMessage('${li.id}')">âŒ</button>`;
 Â Â Â Â  } else if (fixedName === "å‚å£" && m.name !== "ç®¡ç†äºº") {
 Â Â Â Â Â Â  deleteButton = `<button class="delete-btn" onclick="deleteMessage('${li.id}')">âŒ</button>`;
 Â Â Â Â  } else if (fixedName === "å±±ä¸­") {
 Â Â Â Â Â Â  deleteButton = `<button class="delete-btn" onclick="deleteMessage('${li.id}')">âŒ</button>`;
 Â Â Â Â  }
 Â Â  }



 Â Â  li.innerHTML = `<span>${content}</span>${deleteButton}`;
 Â Â  messages.appendChild(li);
 Â Â  messages.scrollTop = messages.scrollHeight;
  }



  function deleteMessage(id) {
 Â Â  const confirmDel = confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
 Â Â  if (confirmDel) socket.emit("delete message", id);
  }
</script>
</body>
</html>
 
